# 社内スケジュール管理システム要件定義書

## 1. プロジェクト概要

### 1.1 システム名
社内スケジュール管理システム

### 1.2 目的
社内のスケジュール管理、設備予約、休暇申請の一元管理を実現し、業務効率化を図る

### 1.3 技術スタック
- **フロントエンド**: Next.js 14 (App Router)
- **バックエンド**: Supabase
  - 認証: Supabase Auth
  - データベース: PostgreSQL
  - リアルタイム: Supabase Realtime
  - ストレージ: Supabase Storage
- **スタイリング**: Tailwind CSS
- **状態管理**: Zustand / React Context API
- **通知**: 
  - メール送信: Resend / SendGrid
  - プッシュ通知: Firebase Cloud Messaging (FCM)
- **カレンダー連携**: Google Calendar API / Apple EventKit

## 2. 機能要件

### 2.1 認証・ログイン機能

#### 2.1.1 基本要件
- メールアドレス（@terao-f.co.jp）とパスワードによる認証
- 共有PC利用を考慮したアカウント切り替え機能
- セッション管理とタイムアウト設定

#### 2.1.2 アカウント切り替え
- ログアウトせずに別アカウントへの切り替えが可能
- 最近使用したアカウントの履歴表示（5件まで）
- クイックスイッチ機能

### 2.2 スケジュール機能

#### 2.2.1 カレンダータブ構成
1. **Myカレンダー**: 個人の総合スケジュール表示
2. **車両予約**: 車両予約専用ビュー
3. **会議室予約**: 会議室予約専用ビュー
4. **サンプル予約**: サンプル設備予約専用ビュー

#### 2.2.2 スケジュール登録項目

##### 基本項目
- **種別**: ドロップダウン選択
  - 15分無料相談
  - オンライン商談
  - 会議
  - 来訪
  - 工事
  - その他（カスタム追加可能）

- **タイトル**: テキスト入力（必須、100文字以内）

- **詳細**: 自由記述テキストエリア（任意、1000文字以内）

- **日時設定**:
  - 開始日時・終了日時（15分単位）
  - 終日設定
  - 繰り返し設定
    - 毎日
    - 毎週（曜日指定）
    - 毎月（日付/曜日指定）
    - 毎年
    - 平日のみ
    - カスタム設定
  - 繰り返し終了条件（日付/回数）

##### 参加者・設備
- **参加者選択**:
  - 所属グループからの選択
  - 業務グループからの選択
  - 個別選択
  - 全員選択/個別解除機能

- **設備予約**:
  - 会議室（複数選択可）
  - 車両（複数選択可）

##### 通知設定
- **リマインダー**:
  - タイミング: 5/10/15/30/60分前
  - 通知方法: メール/プッシュ通知（複数選択可）
  - 複数回通知設定

#### 2.2.3 スケジュール管理ルール
- 全社員が全員のスケジュールを作成・編集・削除可能
- 1日あたり最大10件まで登録可能
- 作成者・編集者情報の自動記録
- 重複チェックと警告表示
- 必須項目の検証とエラー表示

#### 2.2.4 車両予約機能
- 車両一覧表示（カレンダー形式）
- 車両×日付のマトリックス表示
- セルクリックでの予約作成（車両・日付自動入力）
- 予約状況の色分け表示

#### 2.2.5 会議室予約機能
- 会議室一覧表示（カレンダー形式）
- 会議室×日付のマトリックス表示
- セルクリックでの予約作成（会議室・日付自動入力）
- Google Meet連携
  - ミーティングルーム自動作成
  - URL生成とメール送信
  - テンプレート管理

#### 2.2.6 サンプル予約機能
- 設備別予約管理
- 先着順管理（自動採番）
- 1日最大10件制限
- 登録項目:
  - 生産番号（5桁数字）
  - 品番（20文字以内英数字）
  - 枚数
  - 担当者
  - 順番（自動/手動調整可）
- 管理者による順番変更機能
- Excel形式でのエクスポート機能

### 2.3 休暇・遅刻・早退申請機能

#### 2.3.1 申請フロー
1. 申請者が申請作成
2. 休暇申請グループ全員の承認
3. 社長の最終承認
4. 承認完了通知（グループメンバー＋人事）

#### 2.3.2 申請ルール
- 1日単位での申請（連日申請不可）
- 申請先の追加選択可能
- ステータス管理（申請中/承認待ち/承認済み/却下）
- 申請履歴の保存と参照

### 2.4 通知機能

#### 2.4.1 通知種別
- メール通知
- iPhoneカレンダー連携（双方向同期）
- プッシュ通知（通知センター/バッジ）

#### 2.4.2 通知タイミング
- スケジュール作成/変更/削除時
- リマインダー（設定時間前）
- 申請承認依頼/結果通知

#### 2.4.3 通知設定
- 個人デフォルト設定
- スケジュール個別設定
- 複数メールアドレス登録

### 2.5 管理機能（社長・管理者限定）

#### 2.5.1 アカウント管理
- アカウントのCRUD操作
- 権限設定（社長/管理者/社員）
- 一括インポート/エクスポート
- 操作履歴記録

#### 2.5.2 グループ管理
- 所属グループ管理
- 業務グループ作成・編集
- 休暇申請グループ設定
- メンバー一括変更

#### 2.5.3 マスタデータ管理
- 車両情報（車種/ナンバー）
- 会議室情報
- サンプル設備情報
- 種別マスタ

## 3. データベース設計概要

### 3.1 主要テーブル

#### users（ユーザー）
- id (UUID)
- email
- employee_number
- name
- name_kana
- phone
- department_id
- role (社長/管理者/社員)
- default_working_days
- created_at
- updated_at

#### schedules（スケジュール）
- id (UUID)
- type_id
- title
- description
- start_datetime
- end_datetime
- is_all_day
- recurrence_rule
- creator_id
- created_at
- updated_at

#### schedule_participants（参加者）
- schedule_id
- user_id
- status

#### reservations（予約）
- id (UUID)
- schedule_id
- resource_type (車両/会議室/サンプル)
- resource_id
- status

#### leave_requests（休暇申請）
- id (UUID)
- applicant_id
- type (休暇/遅刻/早退)
- date
- reason
- status
- created_at
- updated_at

#### approvals（承認）
- id (UUID)
- leave_request_id
- approver_id
- status
- approved_at
- comment

## 4. 画面構成

### 4.1 共通画面
- ログイン画面
- ダッシュボード
- アカウント切り替えモーダル

### 4.2 メイン画面
- カレンダー画面（4タブ構成）
- スケジュール作成/編集モーダル
- 参加者選択モーダル
- 設備選択モーダル

### 4.3 申請画面
- 休暇申請一覧
- 申請作成/編集フォーム
- 承認画面

### 4.4 管理画面
- ユーザー管理
- グループ管理
- マスタデータ管理
- 操作履歴

## 5. 非機能要件

### 5.1 性能要件
- 同時接続ユーザー数: 100名
- レスポンスタイム: 3秒以内
- 可用性: 99.5%以上

### 5.2 セキュリティ要件
- HTTPS通信必須
- ロールベースアクセス制御
- 操作ログの記録
- セッションタイムアウト（30分）

### 5.3 運用要件
- 自動バックアップ（日次）
- エラー監視とアラート
- 定期メンテナンス窓口

### 5.4 制約事項
- メールドメイン制限（@terao-f.co.jp）
- ブラウザ対応（Chrome, Safari, Edge最新版）
- モバイル対応（レスポンシブデザイン）

## 6. 開発スケジュール（仮）

### Phase 1: 基本機能（2ヶ月）
- 認証・ログイン機能
- 基本的なスケジュール機能
- カレンダー表示

### Phase 2: 予約機能（1.5ヶ月）
- 車両予約
- 会議室予約
- サンプル予約

### Phase 3: 申請機能（1ヶ月）
- 休暇申請フロー
- 承認機能

### Phase 4: 連携・通知（1.5ヶ月）
- メール通知
- カレンダー連携
- プッシュ通知

### Phase 5: 管理機能（1ヶ月）
- 管理画面
- マスタデータ管理

## 7. 今後の検討事項

1. **外部システム連携**
   - 既存の勤怠管理システムとの連携
   - Active Directory連携

2. **モバイルアプリ**
   - ネイティブアプリ開発の検討
   - PWA対応

3. **高度な機能**
   - AI による日程調整提案
   - 会議室の利用統計・分析
   - リソース最適化提案

4. **国際化対応**
   - 多言語対応
   - タイムゾーン対応

5. **拡張性**
   - プラグイン機構
   - API公開
   - Webhook対応

## 8. 実装進捗・完了項目

### 8.1 データベース設計・実装 ✅
- users, groups, schedules, sample_reservations, leave_requests, rooms, vehicles, sample_equipment テーブル作成
- Row Level Security (RLS) ポリシー設定
- 三種類のグループ対応（department, business, leave）

### 8.2 認証機能 ✅
- Supabase Auth統合
- モックユーザーログイン機能
- 現在ユーザー状態管理

### 8.3 スケジュール管理機能 ✅
- カレンダー表示（日・週・月ビュー）
- スケジュール作成・編集・削除
- Supabaseデータ永続化（localStorageを無効化）
- 重複チェック機能
- 1日10件制限

### 8.4 予約機能フォーム分離 ✅
- 車両予約：用途、行き先、目的・詳細
- 会議室予約：会議種別、会議名、議題・詳細、参加者
- サンプル予約：作業種別、生産番号、品番、枚数、担当者、備考

### 8.5 参加者選択UI実装 ✅
- グループベース参加者選択（アコーディオン式）
- 所属・業務・休暇申請グループ対応
- 全員選択機能
- 選択済み参加者表示
- フィルタリング機能（業務グループは本人関連のみ表示）

### 8.6 休暇申請機能 ✅
- 休暇・遅刻・早退申請作成
- 承認フロー（休暇申請グループ → 社長）
- ステータス管理（pending/approved/rejected）
- Supabaseデータ永続化

### 8.7 グループ機能実装 ✅
- 三種類のグループタイプ対応
- 所属グループ（department）：ユーザーの部署から自動生成
- 業務グループ（business）：プロジェクト等の作業グループ
- 休暇申請グループ（leave）：承認権限を持つグループ

### 8.8 今後の実装予定項目
- [x] 会議室予約への参加者選択統合 ← 現在実装中
- [ ] アカウント切り替え機能
- [ ] Google Meet連携
- [ ] iPhone/カレンダー連携
- [ ] サンプル予約の先着順・Excel出力
- [ ] メール/プッシュ通知機能
- [ ] 管理画面実装
- [ ] 15分間隔スケジュール対応
- [ ] 繰り返し予約機能
